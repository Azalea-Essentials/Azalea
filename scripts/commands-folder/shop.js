import{ItemStack as e,system as t,world as o}from"@minecraft/server";import{CommandBuilder as n}from"../commandBuilder";import{commands as r}from"../commands";import{itemToJson as i}from"../conv";import{Database as s}from"../db";import{ActionForm as l}from"../form_func";import{isAdmin as a}from"../isAdmin";import{responseStr as d,SUCCESS as p}from"../response";import{openShopUI as c}from"../shopui";export default function m(){r.addCommand("shop",{description:"Shop",category:"Economy",async onRun(e,o,n,r){let l=new s("ShopADB2");if(o.length){if("raw"==o[0]){let e=l.get("ShopItems",[]);return r(`TEXT ${JSON.stringify(e,null,2)}`)}if("add"==o[0]){if(!a(e.sender))return r("ERROR You require admin");if(o.length<2)return r("ERROR Enter a price");if(!/^\d+$/.test(o[1]))return r("ERROR Invalid price!");let t=e.sender.getComponent("inventory").container.getItem(e.sender.selectedSlot);if(!t)return r("ERROR You need to be holding an item");let n=l.get("ShopItems",[]);return n.push({item:i(t),price:parseInt(o[1])}),l.set("ShopItems",n),r(`SUCCESS Successfully added item to shop for $${parseInt(o[1])}`)}}else{r("SUCCESS Move around to open the shop UI");let o=e.sender.location.x,n=e.sender.location.y,i=e.sender.location.z,s=0,l=e.sender,a=t.runInterval((()=>{e.sender.location.x!=o||e.sender.location.y!=n||e.sender.location.z!=i?(t.clearRun(a),c(l)):(s++,s>10&&t.clearRun(a))}),10)}}}),new n("sell-shop").category("Economy").desc("Sell shop").callback((({msg:e,args:n,response:r})=>{if(n.length&&"set-value"==n[0]){if(!a(e.sender))return r("ERROR You require admin");if(n.length<2)return r("ERROR Enter a price");if(!/^\d+$/.test(n[1]))return r("ERROR Invalid price!");let t=e.sender.getComponent("inventory").container.getItem(e.sender.selectedSlot),o=t.typeId.split(":").slice(1).join(":").split("_").map((e=>`${e[0].toUpperCase()}${e.substring(1)}`)).join(" "),i=new s("SellShop"),l=i.get("Items",{});return l[t.typeId]={price:parseInt(n[1])},i.set("Items",l),r(`SUCCESS Set price of ${o} to $${n[1]}`)}{let n=new l;n.title("Sell Shop");let i=e.sender.getComponent("inventory"),a=i.container,c=new s("SellShop").get("Items",{}),m=[];for(const e of Object.keys(c)){let t=e.split(":").slice(1).join(":").split("_").map((e=>`${e[0].toUpperCase()}${e.substring(1)}`)).join(" ");m.push(`§a${t} §7$${c[e].price}`)}n.body(m.join("\n§r")),n.button("§4Exit",null,(()=>{}));for(let e=0;e<i.inventorySize;e++){let t=a.getItem(e);if(!t)continue;let r=t.typeId.split(":").slice(1).join(":").split("_").map((e=>`${e[0].toUpperCase()}${e.substring(1)}`)).join(" ");c[t.typeId]&&n.button(`${r} x${t.amount}`,null,((n,i)=>{let d=c[t.typeId].price,p=new s("Config"),m=o.scoreboard.getObjective(p.get("MoneyScoreboard","money"));m||(m=o.scoreboard.addObjective(p.get("MoneyScoreboard","money")));let u=0;try{u=m.getScore(n.scoreboardIdentity)}catch{u=0}u||"number"==typeof u||(u=0),u+=d*t.amount,m.setScore(n.scoreboardIdentity,u),a.setItem(e);let f=new l;f.title("Sold!"),f.body(`You have sold ${t.amount}x ${r}`),f.button("Ok",null,((e,t)=>{})),f.show(n,!1,((e,t)=>{}))}))}let u=e.sender.location.x,f=e.sender.location.y,S=e.sender.location.z,y=0,g=t.runInterval((()=>{y++,y>10?t.clearRun(g):e.sender.location.x==u&&f==e.sender.location.y&&S==e.sender.location.z||(t.clearRun(g),n.show(e.sender,!0,((e,t)=>{})))}),10);r(d(p,"Close chat and move to open UI"))}})).register()}