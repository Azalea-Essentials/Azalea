import{world as e}from"@minecraft/server";import{ActionFormData as t,MessageFormData as o,ModalFormData as a}from"@minecraft/server-ui";import n from"./icons";import{jsonToItem as r}from"./conv";import{Database as i}from"./db";import{isAdmin as s}from"./isAdmin";import{uiManager as l}from"./uis";import{ActionForm as c,ModalForm as g}from"./form_func";import{DynamicPropertyDatabase as d}from"./dynamicPropertyDb";import{clear as p}from"./things/Clear";import{ChestFormData as u}from"./chestUI";let m=new i("Config");var f=function(e,t,o){var a=t,n=a+o;if(!(n<0||n==e.length)){var r=[a,n].sort();e.splice(r[0],2,e[r[1]],e[r[0]])}};function y(e,t){return e-e*t/100}var h=function(e,t){f(e,t,-1)},A=function(e,t){f(e,t,1)};function S(e){return(e.nameTag?e.nameTag:`${e.typeId.split(":")[1].split("_").join(" ")[0].toUpperCase()}${e.typeId.split(":")[1].split("_").join(" ").substring(1)}`)+` x${e.amount}`}function b(t){let o=0;try{let a=e.scoreboard.getObjective("multishop");a||(a=e.scoreboard.addObjective("multishop","Multishop")),o=a.getScore(t.scoreboardIdentity)}catch{o=0}return o||(o=0),0==o?"ShopItems":"ShopItems-"+o.toString()}l.addUI("Azalea1.1/Shop/Root/Category",((t,o,a=[])=>{let i=new d("ShopNew"),s=i.get(b(t),"");s||(s=[{category:"Uncategorized",items:[]}],i.set(b(t),s));let p=s.find((e=>e.category==o));if(!p)return l.open("Azalea1.1/Shop/Root",t);let u=new c;p.items&&p.items.length||u.body("Looks like there are no items here!"),u.title(`Shop §7> §r${p.category}`),p.discount&&u.body(`§a${p.discount}%% §r§fdiscount!`),u.button("Leave","textures/azalea_icons/2",(e=>{if(a.length){let t=a.reverse().slice(1),o=a[0];l.open("Azalea1.1/Shop/Root/Category",e,o,t.reverse())}else l.open("Azalea1.1/Shop/Root",e)}));for(const i of p.items){if(i.tag&&t.hasTag(i.tag))continue;let d,f;if(i.category_reference)d=s.find((e=>e.reference_id==i.category_reference))?`${s.find((e=>e.reference_id==i.category_reference)).category}`:"§c§lUnknown Category";else if(i.display)d=i.display;else{let e=r(i.item);d=S(e)}i.icon?f=n.get(i.icon):i.category_reference&&(f=n.get(s.find((e=>e.reference_id==i.category_reference))?.icon)),u.button(`${d}${i.price?""+(p.discount?`\n§r§6 §c§o${i.price} §6${Math.floor(y(i.price,p.discount))}`:`\n§r§6 ${i.price}`):""}`,f&&f.path?f.path:null,((t,n)=>{if(i.category_reference){let e=s.find((e=>e.reference_id==i.category_reference)).category;return void l.open("Azalea1.1/Shop/Root/Category",t,e,[...a,o])}if(!i.price)return;let u=i.price;if(p.discount&&(u=Math.floor(y(i.price,p.discount))),i.tag){let a=new c;return a.title("§bAre you sure?"),a.body(`Are you sure you want to buy ${d} for §6 ${i.price}§r§f?`),a.button("§aYes",null,(t=>{let a=0;try{a=e.scoreboard.getObjective(m.get("MoneyScoreboard","money")?m.get("MoneyScoreboard","money"):"money").getScore(t)}catch{a=0}if(a||(a=0),a>=u){t.addTag(i.tag),e.scoreboard.getObjective(m.get("MoneyScoreboard","money")?m.get("MoneyScoreboard","money"):"money").setScore(t,a-i.price)}l.open("Azalea1.1/Shop/Root/Category",t,o)})),a.button("§cNo",null,(e=>{l.open("Azalea1.1/Shop/Root/Category",e,o)})),void a.show(t,!1,(e=>{}))}let f=new g;f.title(`§6 ${i.price} §r§fper stack`),f.slider("Quantity",1,64,1,1,(e=>{}));let h=e.getPlayers().map((e=>({option:e.name,callback(){},player:e}))),A=s.findIndex((e=>e.category==o));s[A].isGiftable&&f.dropdown("Player Gift",h,h.findIndex((e=>e.option==t.name))),f.show(t,!1,((o,a)=>{let n=a.formValues[0],l=s[A].isGiftable?h[a.formValues[1]].player:t,c=i.price*n,g=0;try{g=e.scoreboard.getObjective(m.get("MoneyScoreboard","money")?m.get("MoneyScoreboard","money"):"money").getScore(t)}catch{g=0}if(g||(g=0),g>=c){g-=c,e.scoreboard.getObjective(m.get("MoneyScoreboard","money")?m.get("MoneyScoreboard","money"):"money").setScore(t,g);let o=l.getComponent("inventory");for(let e=0;e<n;e++){let e=r(i.item);o.container.addItem(e)}l.playSound("note.pling",{pitch:1,volume:.3})}}))}))}u.show(t,!1,((e,t)=>{}))})),l.addUI("Azalea1.1/Shop/Root/AdminManage/Category/Item",((e,t,o)=>{let a=new d("ShopNew"),n=a.get(b(e),"");n||(n=[{category:"Uncategorized",items:[]}],a.set(b(e),n));let r=new c,i=n.find((e=>e.category==t));return i?i.items.length>o?(i.items[o].item?r.body(`§bItem ID: §r${i.items[o].item.typeId}\n§r§bAmount: §rx${i.items[o].item.amount}`):i.items[o].category_reference?r.body(`Category reference: ${i.items[o].category_reference}`):i.items[o].tag&&r.body(`Tag: ${i.items[o].tag}`),r.button("Back","textures/azalea_icons/2",(e=>{l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)})),i.items[o].category_reference?r.button("Jump","textures/azalea_icons/icontextures/feather",(e=>{l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,n.find((e=>e.reference_id==i.items[o].category_reference)).category)})):(r.button("Change item display name","textures/azalea_icons/icontextures/name_tag",(e=>{let r=new g;r.textField("Display Name","Display Name",i.items[o].icon?i.items[o].icon:void 0),r.show(e,!1,((e,r)=>{if(!r.formValues[0])return l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o);n[n.findIndex((e=>e.category==t))].items[o].display=r.formValues[0],a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o)}))})),r.button("Change item icon","textures/azalea_icons/ClickyClick",(e=>{let r=new g;r.textField("Item Icon (From §ehttps://azalea.trashdev.org/id-lists/ui-icons§r§f)","ID",i.items[o].icon?i.items[o].icon:void 0),r.show(e,!1,((e,r)=>{if(!r.formValues[0])return l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o);n[n.findIndex((e=>e.category==t))].items[o].icon=r.formValues[0],a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o)}))})),r.button("Change price","textures/azalea_icons/icontextures/book_04g",(e=>{let r=new g;r.textField("Price","Example: 100",void 0),r.show(e,!1,((e,r)=>{if(!r.formValues[0]||!/^\d+$/.test(r.formValues[0]))return l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o);n[n.findIndex((e=>e.category==t))].items[o].price=parseInt(r.formValues[0]),a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o)}))})),r.button("Change category","textures/azalea_icons/ClickyClick",(e=>{let r=new g;r.textField("Category Name","Category",i.items[o].icon?i.items[o].icon:void 0),r.show(e,!1,((e,r)=>{if(!r.formValues[0])return l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",e,t,o);let i=JSON.parse(JSON.stringify(n[n.findIndex((e=>e.category==t))].items[o]));a.set(b(e),n),n[n.findIndex((e=>e.category==t))].items.splice(o,1),n.find((e=>e.category==r.formValues[0]))?n[n.findIndex((e=>e.category==r.formValues[0]))].items.push(i):n.push({category:r.formValues[0],items:[i]}),a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage",e)}))}))),r.button("Delete","textures/azalea_icons/Delete",(e=>{n[n.findIndex((e=>e.category==t))].items.splice(o,1),a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)})),r.button("Move Up","textures/azalea_icons/Up",(e=>{h(n[n.findIndex((e=>e.category==t))].items,o),a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)})),r.button("Move Down","textures/azalea_icons/Down",(e=>{A(n[n.findIndex((e=>e.category==t))].items,o),a.set(b(e),n),l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)})),void r.show(e,!1,((e,t)=>{}))):l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t):l.open("Azalea1.1/Shop/Root/AdminManage",e)})),l.addUI("Azalea1.1/Shop/Root/AdminManage/Category",((e,t)=>{let o=new d("ShopNew"),a=o.get(b(e),"");a||(a=[{category:"Uncategorized",items:[]}],o.set(b(e),a));let i=new c,s=a.find((e=>e.category==t));if(!s)return l.open("Azalea1.1/Shop/Root/AdminManage",e);i.button("Back","textures/azalea_icons/2",(e=>l.open("Azalea1.1/Shop/Root/AdminManage",e))),i.button("Add Discount","textures/azalea_icons/SetDiscount",((e,n)=>{let r=new g;r.title("Set Discount"),r.slider("Discount",0,100,1,s.discount?s.discount:0),r.show(e,!1,((e,n)=>{let r=a.findIndex((e=>e.category==s.category));return a[r].discount=n.formValues[0],o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e,t)}))})),i.button("Edit Category Name","textures/azalea_icons/icontextures/name_tag",((e,n)=>{let r=new g;r.title("Edit category name"),r.textField("Name","Category name",t),r.show(e,!1,((e,n)=>{if(!n.formValues[0])return l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t);if(n.formValues[0]==t)return l.open("Azalea1.1/Shop/Root/AdminManage",e,t);if(a.find((e=>e.category==n.formValues[0]))){let e=a.findIndex((e=>e.category==n.formValues[0]));a[e].items=[...a[e].items,...s.items];let o=a.findIndex((e=>e.category==t));a.splice(o,1)}else{let e=a.findIndex((e=>e.category==t)),o=s;o.category=n.formValues[0],a.splice(e,1),a.push(o)}return o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e,t)}))})),i.button("Set required tag","textures/azalea_icons/icontextures/name_tag",(e=>{let n=new g;n.textField("Required Tag (Leave blank for none)","Set a tag required to view this category",s.tag?s.tag:void 0),n.show(e,!1,((e,n)=>{if(!n.formValues[0]){let n=a.findIndex((e=>e.category==s.category));return a[n].tag="",o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)}let r=a.findIndex((e=>e.category==s.category));return a[r].tag=n.formValues[0],o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e,t)}))})),i.button("Edit Category Icon","textures/azalea_icons/ClickyClick",((e,n)=>{let r=new g;r.textField("Category Icon (From §ehttps://azalea.trashdev.org/id-lists/ui-icons§r§f)","Put an Icon ID",s.icon?s.icon:void 0),r.show(e,!1,((e,n)=>{if(!n.formValues[0])return l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t);let r=a.findIndex((e=>e.category==s.category));return a[r].icon=n.formValues[0],o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e,t)}))})),i.button("Delete","textures/azalea_icons/Delete",((e,n)=>{let r=new c;r.body(`Are you sure you want to delete this category and ${s.items.length} item(s)?`),r.button("§aYes",null,((e,t)=>{a.splice(a.findIndex((e=>e.category==s.category)),1),o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e)})),r.button("§cNo",null,((e,o)=>{l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)})),r.show(e,!1,((e,t)=>{}))}));for(let e=0;e<s.items.length;e++){let o,c=s.items[e],g=n.get(c.icon);if(c.category_reference){if(!a.find((e=>e.reference_id==c.category_reference)))continue;o=a.find((e=>e.reference_id==c.category_reference)).category,g=n.get(a.find((e=>e.reference_id==c.category_reference)).icon)}else if(c.display)o=c.display;else{o=S(r(c.item))}i.button(`${o}${c.price?`\n§r§6 ${c.price}`:""}`,g&&g.path?g.path:null,(o=>{l.open("Azalea1.1/Shop/Root/AdminManage/Category/Item",o,t,e)}))}i.button("Move Up","textures/azalea_icons/Up",(e=>{h(a,a.findIndex((e=>e.category==t))),o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e)})),i.button("Move Down","textures/azalea_icons/Down",(e=>{A(a,a.findIndex((e=>e.category==t))),o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage",e)})),i.button(a.find((e=>e.category==t)).isGiftable?"Disable Gifting":"Enable Gifting",null,(e=>{if(a.find((e=>e.category==t))){let n=a.findIndex((e=>e.category==t));a[n].isGiftable=!a[n].isGiftable,o.set(b(e),a)}l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)})),i.button("Add Buyable Tag",null,(e=>{let n=new g;n.title("Buyable Tag"),n.textField("Tag","Tag to add to player",void 0),n.textField("Price","Price (Example: 100)",void 0),n.textField("Display Name","Display name",void 0),n.show(e,!1,((e,n)=>{if(!n.formValues[0])return l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t);if(!n.formValues[1]||!/^\d+$/.test(n.formValues[1]))return l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t);if(!n.formValues[2])return l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t);let r=a.findIndex((e=>e.category==t));a[r].items.push({price:parseInt(n.formValues[1]),tag:n.formValues[0],display:n.formValues[2]}),o.set(b(e),a),l.open("Azalea1.1/Shop/Root/AdminManage/Category",e,t)}))})),i.button("Import Category",null,(e=>{let n=new c;for(const e of a)n.button(e.category,null,(n=>{let r=a.findIndex((e=>e.category==t)),i=a.findIndex((t=>t.category==e.category));a[i].reference_id||(a[i].reference_id=Date.now()),a[r].items.push({category_reference:a[i].reference_id,display:"UPDATE"}),o.set(b(n),a)}));n.show(e,!1,(e=>{}))})),i.show(e,!1,((e,t)=>{}))})),l.addUI("Azalea1.1/Shop/Root/AdminManage/Transfer/Confirm",((e,t)=>{let o=new c;o.body(`Are you sure you want to overwrite the items in your current shop with the ones in shop ${t}?`),o.button("§cNo",null,(e=>{l.open("Azalea1.1/Shop/Root/AdminManage",e)})),o.button("§aYes",null,((e,o)=>{let a=0==t?"ShopItems":`ShopItems-${t}`,n=new d("ShopNew");n.set(b(e),n.get(a)),l.open("Azalea1.1/Shop/Root",e)})),o.show(e,!1,(e=>{}))})),l.addUI("Azalea1.1/Shop/Root/AdminManage/Transfer",(e=>{let t=new c,o=new d("ShopNew").gkeys.filter((e=>e.startsWith("ShopItems")&&!e.endsWith("Title")&&!e.endsWith("Body"))).map((e=>"ShopItems"==e?0:parseInt(e.substring(10))));t.body("§c§lThis is dangerous! This will copy items from another shop to your current shop, and will overwrite all other items! Don't use this if you do not know what you are doing."),t.button("Back",null,(e=>{l.open("Azalea1.1/Shop/Root/AdminManage",e)}));for(const e of o)t.button(`Shop ${e}`,null,(t=>{l.open("Azalea1.1/Shop/Root/AdminManage/Transfer/Confirm",t,e)}));t.show(e,!1,(e=>{}))})),l.addUI("Azalea1.1/Shop/Root/AdminManage",(e=>{let t=new d("ShopNew"),o=t.get(b(e),"");o||(o=[{category:"Uncategorized",items:[]}],t.set(b(e),o));let a=new c;o.length||a.button("§cExit",null,(()=>{})),a.button("Back","textures/azalea_icons/2",(e=>{l.open("Azalea1.1/Shop/Root",e)}));for(const e of o){let t=n.get(e.icon);t||(t=null),a.button(e.category,t&&t.path?t.path:null,((t,o)=>{l.open("Azalea1.1/Shop/Root/AdminManage/Category",t,e.category)}))}a.button("Edit Shop UI",null,((e,o)=>{let a=t.get(b(e)+"-Title","");a||(a=void 0);let n=t.get(b(e)+"-Body","");n||(n=void 0);let r=new g;r.textField("Title","UI Title",a),r.textField("Body","UI Body",n),r.textField("Tag Required","Tag Required",n),r.show(e,!1,((e,o)=>{o.formValues[0]?t.set(b(e)+"-Title",o.formValues[0]):t.set(b(e)+"-Title",""),o.formValues[1]?t.set(b(e)+"-Body",o.formValues[1]):t.set(b(e)+"-Body",""),l.open("Azalea1.1/Shop/Root/AdminManage",e)}))})),a.button("New Category",null,((e,a)=>{o.push({category:"New Category"+(0==o.filter((e=>e.category.startsWith("New Category"))).length?"":` ${o.filter((e=>e.category.startsWith("New Category"))).length}`),items:[]}),t.set(b(e),o)})),a.button("§cTransfer from other shop",null,((e,t)=>{l.open("Azalea1.1/Shop/Root/AdminManage/Transfer",e)})),a.show(e,!1,((e,t)=>{}))})),l.addUI("Azalea2.0/ShopChest/Root/Category",((e,t)=>{let o=new d("ShopNew"),a=o.get(b(e),""),r=o.get(b(e)+"-Title","");r||(r="");let i=o.get(b(e)+"-Body","");i||(i=""),a||(a=[{category:"Uncategorized",items:[]}],o.set(b(e),a));let s=a.findIndex((e=>e.category==t)),c=Math.floor(a[s].items.length/9),g=new u((9*(c+1)).toString());for(let e=9*c;e<9*(c+1);e++)e!=9*c+4&&g.button(e,"§cX","","textures/blocks/glass_gray",1);g.button(9*c+4,"§cBack",["Go back to main shop page"],"textures/azalea_icons/2",1);let p=-1,m=0,f=0,y=0,h=0,A=[];g.title(`Chest Shop - ${a[s].category}`);for(const e of a[s].items){if(e.category_reference){if(!a.find((t=>t.reference_id==e.category_reference)))continue}p++;let t=0;if(0==p&&(t=4),p%9==0&&0!=p?(f=0,y=0,h+=9,t=4+h):0!=p&&p%2==0?(t=4-(1+y)+h,y++):0!=p&&p%2!=0&&(t=4+(1+f)+h,f++),m=t,A.push([t,e]),e.category_reference){let o=a.find((t=>t.reference_id==e.category_reference)),r=n.get(o.icon);g.button(t,`${o.category}`,[`Item Count: ${o.items.length}`],r&&r.path?r.path:"textures/azalea_icons/Info")}}g.show(e).then((o=>{if(!o.canceled)if(o.selection==9*c+4)l.open("Azalea2.0/ShopChest/Root",e);else if(o.selection<a[s].items){a[s].items[o.selection]}else A.find((e=>e[0]==o.selection))||l.open("Azalea2.0/ShopChest/Root/Category",e,t)}))})),l.addUI("Azalea2.0/ShopChest/Root",(e=>{let t=new d("ShopNew"),o=t.get(b(e),""),a=t.get(b(e)+"-Title","");a||(a="");let r=t.get(b(e)+"-Body","");r||(r=""),o||(o=[{category:"Uncategorized",items:[]}],t.set(b(e),o));let i=new u("27");i.title(a||"Chest Shop");let s=-1;for(let e=18;e<27;e++)22!=e&&i.button(e,"§cX","","textures/blocks/glass_black",1);i.button(22,"§dBack to normal layout",["Changes the Chest UI to the other Shop UI"],"textures/azalea_icons/Settings",1);let c=[];for(const e of o){let{category:t,items:a}=e;if(e.reference_id&&o.find((t=>t.items.findIndex((t=>t.category_reference==e.reference_id))>=0)))continue;s++,c.push(o.findIndex((e=>e.category==t)));let r=n.get(e.icon);i.button(s,`${t}`,[`Item Count: ${a.length}`],r&&r.path?r.path:"textures/azalea_icons/Info",1)}i.show(e).then((t=>{if(!t.canceled)if(22!=t.selection)if(c.length>t.selection){let a=c[t.selection];l.open("Azalea2.0/ShopChest/Root/Category",e,o[a].category)}else l.open("Azalea2.0/ShopChest/Root",e);else{try{e.removeTag("chest-shop")}catch{}l.open("Azalea1.1/Shop/Root",e)}}))})),l.addUI("Azalea1.1/Shop/Root",(e=>{if(e.hasTag("chest-shop"))return l.open("Azalea2.0/ShopChest/Root",e);let t=new c,o=new d("ShopNew"),a=new i("ShopADB2"),r=o.get(b(e),""),g=o.get(b(e)+"-Title","");g||(g="");let p=o.get(b(e)+"-Body","");if(p||(p=""),r||(r=[{category:"Uncategorized",items:[]}],o.set(b(e),r)),s(e)&&"TRUE"!=a.get("Converted","FALSE")&&a.get(b(e),[]).length)t.body("Looks like you used shop on azalea versions before V1.1. To use the new shop update, you need to convert the old shop."),t.button("Convert",null,((e,t)=>{let n=a.get(b(e),[]),r={};for(let e=0;e<n.length;e++){let t=n[e],o=t.category||"Uncategorized";r[o]||(r[o]=[]),r[o].push({...t,index:e})}let i=[];for(const e of Object.keys(r))i.push({category:e,items:r[e]});o.set(b(e),i),a.set("Converted","TRUE")}));else{g&&t.title(g),p&&t.body(p),s(e)&&t.button("Admin: Manage Shop","textures/azalea_icons/icontextures/cake",((e,t)=>{l.open("Azalea1.1/Shop/Root/AdminManage",e)}));for(const o of r){if(o.reference_id&&r.find((e=>e.items.find((e=>e.category_reference==o.reference_id)))))continue;let a=n.get(o.icon);a||(a=null),(!o.tag||e.hasTag(o.tag)||s(e))&&t.button(o.category,a&&a.path?a.path:null,((e,t)=>{l.open("Azalea1.1/Shop/Root/Category",e,o.category)}))}}t.show(e,!1,((e,t)=>{}))}));export function openShopUI(e){return l.open("Azalea1.1/Shop/Root",e)}