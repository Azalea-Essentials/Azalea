import{Player as e,system as t,world as o}from"@minecraft/server";import{ActionFormData as n,ModalFormData as r}from"@minecraft/server-ui";import{warps as s}from"./warpsapi";import{baseConfigMenu as l}from"./configuratorOptions";import{Database as a}from"./db";import{ActionForm as i,MessageForm as c,ModalForm as p}from"./form_func";import{isAdmin as f}from"./isAdmin";import{openShopUI as d}from"./shopui";import{uiManager as u}from"./uis";import m from"./icons";import{openConfigUI as g}from"./configuratorBase";o.afterEvents.playerSpawn.subscribe((e=>{})),o.afterEvents.playerLeave.subscribe((e=>{if(WelcomeMessageEnabled)for(const e of o.getPlayers())e.playSound("note.bit",{pitch:.5})})),u.addUI("Azalea1.1/Warps",(e=>{let t=s.getAllWarps(),o=new a("WarpUI"),n=new i;n.title(o.get("Title","§dWarp UI")?o.get("Title","§dWarp UI"):"§dWarp UI"),t.length||(n.title("Warps - Not Configured"),n.body("§cIt looks like warps are not configured on this server.\n§bFor admins: do §e!spawn set §bto set spawn, and §e!warp set <name> §bto set a warp."),n.button("§cLeave","textures/azalea_icons/2",((e,t)=>{})));for(const e of t){let t=s.get2(e),o=m.find((e=>e.name==t.icon));o=o&&o.path?o.path:null,n.button(`§a${t.displayName?t.displayName:"spawn"==e?"§dWorld Spawn":e}`,o||("spawn"==e?"textures/azalea_icons/icontextures/nether_star":"textures/azalea_icons/icontextures/ender_pearl"),(t=>{s.tpDB(t,e)}))}n.show(e,!1,((e,t)=>{}))})),o.beforeEvents.itemUse.subscribe((e=>{t.run((()=>{if("azalea:player_shop"==e.itemStack.typeId&&u.open("Azalea0.9.1/PlayerShop/Main",e.source),"azalea:tp_requests"==e.itemStack.typeId&&u.open("Azalea2.0/TeleportRequests/Root",e.source),"azalea:warp"==e.itemStack.typeId&&u.open("Azalea1.1/Warps",e.source),"azalea:shop"==e.itemStack.typeId&&d(e.source),"azalea:config_ui"==e.itemStack.typeId&&f(e.source)){let s=l.options;if(e.source.hasTag("experiment-1"))return void g(e.source,l.toOptions(),"Config UI V2");e.cancel=!0;let i=e.source;t.run((()=>{let e=new n;e.title((i.hasTag("light-mode")?"§l§i§g§h§t":"")+"§r§dConfig Menu");let t=[];for(const o of Object.keys(s)){if(o.toLowerCase().includes("quests")){if(!("true"==new a("Config").get("QuestsEnabled","false")))continue}t.push(o),e.button(o,s[o].icon)}e.show(i).then((e=>{if(e.canceled)return;let l=s[t[e.selection]];if(l.type&&"func"==l.type)return void l.options[0].fn(i,e);if(l.type&&"hardcoded-playermenu"==l.type){let e=new n,t=[];for(const n of o.getPlayers())t.push(n),e.button(`${n.name} ${f(n)?"§t(ADMIN)":"§n(MEMBER)"}`);return void e.show(i).then((e=>{if(e.canceled)return;let o=new n;o.button("Color info"),o.button("Ranks"),o.show(i).then((o=>{if(!o.canceled)if(0==o.selection){let o=new r,n=["Default Color","§0Color 0","§1Color 1","§2Color 2","§3Color 3","§4Color 4","§5Color 5","§6Color 6","§7Color 7","§8Color 8","§9Color 9","§aColor A","§bColor B","§cColor C","§dColor D","§eColor E","§fColor F","§gColor G","§hColor H","§jColor J","§mColor M","§nColor N","§tColor T","§uColor U","§iColor I","§pColor P","§qColor Q"],s=t[e.selection].getTags().find((e=>e.startsWith("name-color:"))),l=s?n.findIndex((e=>e.startsWith(s.substring(11)))):0;o.dropdown("Name color",n,l);let a=t[e.selection].getTags().find((e=>e.startsWith("message-color:"))),c=a?n.findIndex((e=>e.startsWith(a.substring(14)))):0;o.dropdown("Message color",n,c);let p=t[e.selection].getTags().find((e=>e.startsWith("bracket-color:"))),f=p?n.findIndex((e=>e.startsWith(p.substring(14)))):0;o.dropdown("Bracket color",n,f);let d=["name-color:","message-color:","bracket-color:"];o.show(i).then((o=>{if(!o.canceled)for(let r=0;r<o.formValues.length;r++){let s=o.formValues[r];if("number"==typeof s){if(n[s].startsWith("D")){let o=t[e.selection].getTags().filter((e=>e.startsWith(d[r])));if(o&&o.length)for(const n of o)t[e.selection].removeTag(n)}else{let o=t[e.selection].getTags().filter((e=>e.startsWith(d[r])));if(o&&o.length)for(const n of o)t[e.selection].removeTag(n);t[e.selection].addTag(`${d[r]}${n[s][0]}${n[s][1]}`)}}}}))}else if(1==o.selection){let o=t[e.selection],s=new n;s.title(`${o.name} - Rank Actions`),s.button("Add rank"),s.button("Remove rank"),s.show(i).then((e=>{if(!e.canceled)if(0==e.selection){let e=new r;e.textField("Rank name (you can use & instead of the normal character for color codes)","Type a rank name"),e.show(i).then((e=>{if(e.canceled)return;let t=e.formValues[0];t&&(o.addTag(`rank:${t.replace(/\&/g,"§")}`),o.sendMessage(`You have been given a rank: ${t}`))}))}else if(1==e.selection){let e=new n,t=o.getTags().filter((e=>e.startsWith("rank:"))).map((e=>e.substring(5)));for(const o of t)e.button(o);e.show(i).then((e=>{if(e.canceled)return;let n=t[e.selection];o.removeTag(`rank:${n}`)}))}}))}}))}))}let c=new r,p=new a("Config"),d=o.scoreboard.getObjective("cmdtoggles");d||(d=o.scoreboard.addObjective("cmdtoggles"));for(const e of l.options)if("toggle"==e.type){let t=p.get(e.key)?p.get(e.key):null;c.toggle(e.label,!!t&&"true"==t)}else if("text-input"==e.type){let t=p.get(e.key)?p.get(e.key):null;c.textField(e.label,e.placeholder,t)}else if("dropdown"==e.type){let t=p.get(e.key)?p.get(e.key):null,o=e.keyOptions.findIndex((e=>e==t));c.dropdown(e.label,["Select an option",...e.cliOptions],o<0?null:o+1)}else if("dropdown-command"==e.type){let t=0;try{t=d.getScore(e.command),t||(t=0)}catch{t=0}c.dropdown("!"+e.command+" toggle",["Default permissions","Force admins only","Completely disabled","Enabled for everyone"],t)}else"slider"==e.type&&c.slider(e.label,e.minVal,e.maxVal,e.step,p.get(e.key)==`NUM:${e.default}`?e.default:p.get(e.key)?parseInt(p.get(e.key).substring(4)):e.default);c.title(`${i.hasTag("light-mode")?"§l§i§g§h§t":""}§r${"Config menu - "+t[e.selection]}`),c.show(i).then((e=>{if(!e.canceled)for(let t=0;t<e.formValues.length;t++){let o=e.formValues[t];if("string"==typeof o){console.warn(l.options[t].key),o!=p.get(l.options[t].key)&&p.set(l.options[t].key,o)}else"boolean"==typeof o?p.set(l.options[t].key,o?"true":"false"):"number"==typeof o&&("dropdown-command"==l.options[t].type?d.setScore(l.options[t].command,o):"slider"==l.options[t].type?p.set(l.options[t].key,`NUM:${o}`):o>0&&p.set(l.options[t].key,l.options[t].keyOptions[o-1]))}}))}))}))}}))}));