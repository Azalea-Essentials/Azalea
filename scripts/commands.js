import{system as e,world as r}from"@minecraft/server";import{Database as o}from"./db";import{isAdmin as a}from"./isAdmin";import{Theme as t}from"./themes";import s from"./translation";import{DynamicPropertyDatabase as n}from"./dynamicPropertyDb";class l{constructor(){this.$extensions=[],this.toggleDb=new o("ExtensionConfig")}registerExtension(e){this.$extensions.find((r=>r.id==e))||this.$extensions.push({id:e,events:{},data:{},disabled:!!this.toggleDb.get(e)&&"disabled"==this.toggleDb.get(e)})}disableExtension(e){let r=this.getExtensionIndexByID(e);r>=0&&(this.toggleDb.set(e,"disabled"),this.$extensions[r].disabled=!0)}enableExtension(e){let r=this.getExtensionIndexByID(e);r>=0&&(this.toggleDb.set(e,"enabled"),this.$extensions[r].disabled=!1)}getExtensionIndexByID(e){return this.$extensions.findIndex((r=>r.id==e))}registerExtensionEvent(e,r,o){let a=this.getExtensionIndexByID(e);this.$extensions[a].events[r]=o,"initialize"==r&&this.callExtensionEvent(e,"initialize")}callExtensionEvent(e,r,...o){let a=this.getExtensionIndexByID(e);return this.$extensions[a].disabled?null:this.$extensions[a].events[r](...o)}setTempVar(e,r,o){let a=this.getExtensionIndexByID(e);this.$extensions[a].data[r]=o}getTempVar(e,r){let o=this.getExtensionIndexByID(e);return this.$extensions[o].data[r]}deleteTempVar(e,r){let o=this.getExtensionIndexByID(e);delete this.$extensions[o].data[r]}setVar(e,r,o){new n(e+"-EXTENSION").set(r,o)}getVar(e,r){return new n(e+"-EXTENSION").get(r)}deleteVar(e,r){new n(e+"-EXTENSION").delete(r)}callExtensionEvents(e,...r){let o=[];for(const a of this.$extensions)a.disabled||a.events[e]&&o.push(a.events[e](...r));return o}}export class Commands extends l{constructor(){super(),this.themeMgr=new t,this._cmds=[]}addCommand(e,r){const{description:o="No Description",category:a="Uncategorized",usage:t="No Usage Description",author:s="TRASH",onRun:n,cb_version:l=1,admin:i=!1,isDev:d=!1,deprecated:c=!1,aliases:m=[]}=r;this._cmds.push({name:e,description:o,category:a,usage:t,author:s,onRun:n,cb_version:l,admin:!!i,isDev:!!d,aliases:m,private:(r.private,r.private),deprecated:!!c})}run(o,t){e.run((()=>{let s=o.message.substring(t.length).split(" ")[0],n=!1;s.startsWith("*")&&(s=s.substring(1),n=!0);let l=o.message.substring(t.length).split(" ").slice(1),i=this._cmds,d=this.callExtensionEvents("get_commands");if(d.length)for(const e of d)e&&(i=[...i,...e]);let c=this._cmds.find((e=>e.name==s||e.aliases.includes(s))),m=r.scoreboard.getObjective("themes");m||(m=r.scoreboard.addObjective("themes","Themes"));let u=0;try{u=m.getScore(o.sender.scoreboardIdentity)}catch{u=0}u||(u=0);let g=this.themeMgr.getTheme(u);if(c&&c.isDev&&!o.sender.hasTag("devmode"))return void this.callExtensionEvent("internal","process_response",o.sender,"ERROR You need to do {{ALT}}/tag @s add devmode {{RESET}}to run this command",g);let h=r.scoreboard.getObjective("cmdtoggles");h||(h=r.scoreboard.addObjective("cmdtoggles","Command Toggles"));let p=0;try{p=h.getScore(s)}catch{p=0}if(p||(p=0),1==p&&!a(o.sender))return void(n||this.callExtensionEvent("internal","process_response",o.sender,"ERROR You need to admin to run this command. Try doing {{ALT}}/tag @s add admin{{RESET}}.",g));if(2==p)return void(n||this.callExtensionEvent("internal","process_response",o.sender,"ERROR This command has been disabled by the admins.",g));if(c&&3!=p&&c.admin&&!a(o.sender))return void(n||this.callExtensionEvent("internal","process_response",o.sender,"ERROR You need to admin to run this command. Try doing {{ALT}}/tag @s add admin{{RESET}}.",g,t));let f=o.sender;this.callExtensionEvents(`run_command:${s}`,o,l,g,(r=>{console.warn("S"),e.run((()=>{n||this.callExtensionEvent("internal","process_response",f,r,g,t)}))}),i,t,s,this.$extensions);let C=this.callExtensionEvents("run_command",o,l,g,(r=>{console.warn("S"),e.run((()=>{n||this.callExtensionEvent("internal","process_response",f,r,g,t)}))}),i,t,s,this.$extensions);if(c){if(1!=c.cb_version){return void c.onRun({msg:o,args:l,theme:g,response:e=>{n||this.callExtensionEvent("internal","process_response",o.sender,e,g,t)},cmdsList:i,prefix:t,command:s,extensions:this.$extensions})}c.onRun(o,l,g,(r=>{console.warn("S"),e.run((()=>{n||this.callExtensionEvent("internal","process_response",f,r,g,t)}))}),i,t,s,this.$extensions)}else C.includes(!0)||n||this.callExtensionEvent("internal","process_response",o.sender,"ERROR Command not found. Do {{ALT}}!cmds {{RESET}}to get a list of commands.",g)}))}use(){}}export const commands=new Commands;commands.registerExtension("internal"),commands.registerExtensionEvent("internal","parse_response_variables",((e,r="")=>{let o=e.split(" ")[0].toLowerCase(),a=e.split(" ").slice(1).join(" ");return r&&(a=a.replaceAll("{{PREFIX}}",r)),{type:o,text:a}})),commands.registerExtensionEvent("internal","process_response",((e,r,o,a="")=>{let t=commands.callExtensionEvent("internal","parse_response_variables",r,a);switch(t.type){case"text":e.sendMessage(t.text),e.playSound("note.pling",{pitch:1,volume:.3});break;case"info":e.sendMessage(`${o.infoColor}§lINFO §r§l§8» §r§7${t.text.replaceAll("{{ALT}}",`§r${o.infoColor}§o`).replaceAll("{{RESET}}","§r§7")}`),e.playSound("note.pling",{pitch:1,volume:.3});break;case"error":e.sendMessage(`${o.errorColor}§lERROR §r§l§8» §r§7${t.text.replaceAll("{{ALT}}",`§r${o.errorColor}§o`).replaceAll("{{RESET}}","§r§7")}`),e.playSound("random.glass",{pitch:1,volume:.3});break;case"warn":e.sendMessage(`${o.warningColor}§lWARNING §r§l§8» §r§7${t.text.replaceAll("{{ALT}}",`§r${o.warningColor}§o`).replaceAll("{{RESET}}","§r§7")}`),e.playSound("random.glass",{pitch:1,volume:.3});break;case"success":e.sendMessage(`${o.successColor}§lSUCCESS §r§l§8» §r§7${t.text.replaceAll("{{ALT}}",`§r${o.successColor}§o`).replaceAll("{{RESET}}","§r§7")}`),e.playSound("note.pling",{pitch:1.2,volume:.3});break;case"deprinfo":e.sendMessage(`§c§lDEPRECATED §r§l§8» §r§7${t.text}`),e.playSound("random.glass",{pitch:.7,volume:.3});break;case"wait":e.playSound("note.pling",{pitch:1,volume:.3}),e.sendMessage(`§d§lWAIT §r§l§8» §r§7${t.text}`)}})),commands.registerExtension("extension_store"),commands.registerExtension("translation"),commands.registerExtensionEvent("translation","initialize",(()=>{commands.setTempVar("extension_store","translation_file",s)})),commands.registerExtensionEvent("translation","get_translation",(e=>{let o=r.scoreboard.getObjective("translation");o||(o=r.scoreboard.addObjective("translation","Preferred Languages"));let a=0;try{a=o.getScore(e.scoreboardIdentity)}catch{a=0}return a||(a=0),a>=s.languages.length&&(a=s.languages.length-1),a<0&&(a=0),s[s.languages[a].key]})),commands.themeMgr.addTheme({name:"Default Azalea",descriptionText:"Default.",successColor:"§a",errorColor:"§c",infoColor:"§b",darkSuccess:"§2",darkError:"§4",darkInfo:"§9",defaultBracketColor:"§8",defaultRankColor:"§b",defaultNameColor:"§3",defaultMessageColor:"§7",barFull:"§a",barEmpty:"§c",barBracket:"§7",category:"§8",header:"§e",footer:"§f",footerAlt:"§o§7",command:"§a",description:"§7",alias:"§b",warningColor:"§e"}),commands.themeMgr.addTheme({name:"Ocean",descriptionText:"Blue everywhere, sometimes green because minecraft doesnt have enough blue colors.",successColor:"§a",errorColor:"§m",infoColor:"§9",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§t",defaultRankColor:"§b",defaultNameColor:"§9",defaultMessageColor:"§h",barFull:"§3",barEmpty:"§t",barBracket:"§b",category:"§t",command:"§a",description:"§3",header:"§b",footer:"§f",footerAlt:"§o§b",alias:"§s",warningColor:"§g"}),commands.themeMgr.addTheme({name:"Blood",descriptionText:"red",successColor:"§q",errorColor:"§m",infoColor:"§9",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§4",defaultRankColor:"§c",defaultNameColor:"§n",defaultMessageColor:"§m",barFull:"§4",barEmpty:"§8",barBracket:"§c",category:"§4",command:"§5",description:"§8",header:"§c",footer:"§7",footerAlt:"§o§c",alias:"§s",warningColor:"§g"}),commands.themeMgr.addTheme({name:"Test",descriptionText:"red",successColor:"§a",errorColor:"§4",infoColor:"§3",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§4",defaultRankColor:"§c",defaultNameColor:"§n",defaultMessageColor:"§m",barFull:"§4",barEmpty:"§8",barBracket:"§c",category:"§6",command:"§c",description:"§7",header:"§d",footer:"§7",footerAlt:"§o§c",alias:"§s",warningColor:"§g"}),commands.themeMgr.addTheme({name:"Minecraft",descriptionText:"Default-like minecraft command colors",successColor:"§a",errorColor:"§4",infoColor:"§3",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§f",defaultRankColor:"§e",defaultNameColor:"§a",defaultMessageColor:"§f",barFull:"§4",barEmpty:"§8",barBracket:"§c",category:"§2",command:"§e",description:"§r",header:"§2",footer:"§f",footerAlt:"§o§e",alias:"§s",warningColor:"§g"}),commands.themeMgr.addTheme({name:"A theme.",descriptionText:"Theme.",successColor:"§b",errorColor:"§d",infoColor:"§u",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§d",defaultRankColor:"§c",defaultNameColor:"§e",defaultMessageColor:"§h",barFull:"§b",barEmpty:"§d",barBracket:"§9",category:"§d",command:"§9",description:"§d",alias:"§u",warningColor:"§6"}),commands.themeMgr.addTheme({name:"ZSTheme",descriptionText:"a",successColor:"§2",errorColor:"§4",infoColor:"§b",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§8",defaultRankColor:"§8",defaultNameColor:"§a",defaultMessageColor:"§3",barFull:"§a",barEmpty:"§j",barBracket:"§d",category:"§9",command:"§8",description:"§2",alias:"§h",warningColor:"§c"}),commands.themeMgr.addTheme({name:"Grandpas ashes",descriptionText:"what",successColor:"§c",errorColor:"§e",infoColor:"§g",darkSuccess:null,darkError:null,darkInfo:null,defaultBracketColor:"§c",defaultRankColor:"§p",defaultNameColor:"§g",defaultMessageColor:"§e",barFull:"§c",barEmpty:"§e",barBracket:"§j",category:"§h",command:"§j",description:"§e",alias:"§g",warningColor:"§6"}),commands.themeMgr.addTheme({name:"Random Theme",descriptionText:"a",successColor:"§a",errorColor:"§c",infoColor:"§b",darkSuccess:"§q",darkError:"§m",darkInfo:"§t",defaultBracketColor:"§8",defaultRankColor:"§6",defaultNameColor:"§c",defaultMessageColor:"§d",barFull:"§a",barEmpty:"§c",barBracket:"§7",category:"§8",header:"§a",command:"§d",description:"§f",alias:"§h",warningColor:"§g"}),commands.themeMgr.addTheme({name:"October 2023 Submission 1",descriptionText:"Made by TRASH",successColor:"§a",errorColor:"§c",infoColor:"§s",defaultBracketColor:"§4",defaultRankColor:"§5",defaultNameColor:"§6",defaultMessageColor:"§e",barFull:"§c",barEmpty:"§m",barBracket:"§4",category:"§6",command:"§c",description:"§5",alias:"§6",warningColor:"§p",header:"§5"}),commands.themeMgr.addTheme({name:"LB Theme 1",descriptionText:"Made by TRASH",successColor:"§a",errorColor:"§c",infoColor:"§s",defaultBracketColor:"§7",defaultRankColor:"§a",defaultNameColor:"§e",defaultMessageColor:"§b",barFull:"§c",barEmpty:"§m",barBracket:"§4",category:"§8",command:"§a",description:"§7",alias:"§6",warningColor:"§p",header:"§b"}),commands.themeMgr.addTheme({name:"LB Theme 2",descriptionText:"Made by TRASH",successColor:"§a",errorColor:"§c",infoColor:"§s",defaultBracketColor:"§8",defaultRankColor:"§b",defaultNameColor:"§3",defaultMessageColor:"§e",barFull:"§c",barEmpty:"§m",barBracket:"§4",category:"§c",command:"§3",description:"§6",alias:"§6",warningColor:"§p",header:"§e"}),commands.themeMgr.addTheme({name:"Leaderboard Purple",descriptionText:"A simple purple/green/yellow theme for leaderboards",successColor:"§a",errorColor:"§c",infoColor:"§s",defaultBracketColor:"§8",defaultRankColor:"§u",defaultNameColor:"§e",defaultMessageColor:"§e",leaderboardNumber:"§d",leaderboardScore:"§a",barFull:"§c",barEmpty:"§m",barBracket:"§4",category:"§5",command:"§d",description:"§6",alias:"§6",warningColor:"§p",header:"§d"});